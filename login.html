<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Entrar | Aranhas do Rapel</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

    <style>
        :root { --primary: #E83D8A; --secondary: #0055A4; --dark: #1A202C; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { 
            background: linear-gradient(135deg, var(--secondary) 0%, #003e7a 100%);
            height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
        }

        .login-card {
            background: white; width: 100%; max-width: 400px; padding: 2rem;
            border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
        }

        .logo { width: 80px; height: 80px; object-fit: contain; margin-bottom: 1rem; }
        h2 { color: var(--dark); margin-bottom: 0.5rem; }
        p { color: #666; margin-bottom: 2rem; font-size: 0.9rem; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; font-size: 0.9rem; }
        input { 
            width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; 
            font-size: 1rem; transition: 0.3s; outline: none;
        }
        input:focus { border-color: var(--primary); }

        .btn-login {
            background: var(--primary); color: white; border: none; width: 100%;
            padding: 12px; border-radius: 50px; font-weight: bold; font-size: 1rem;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .btn-login:hover { transform: translateY(-2px); filter: brightness(1.1); }

        .divider { margin: 25px 0; position: relative; }
        .divider::before { content: ""; position: absolute; top: 50%; left: 0; width: 100%; height: 1px; background: #eee; }
        .divider span { position: relative; background: white; padding: 0 10px; color: #999; font-size: 0.8rem; }

        /* BOTÃO GOOGLE FIXO */
        .btn-google {
            background: white; color: #333; border: 2px solid #eee; width: 100%;
            padding: 12px; border-radius: 50px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: 0.3s;
        }
        .btn-google:hover { background: #f9f9f9; border-color: #ddd; }
        .btn-google img { width: 20px; }

        .toggle-link { margin-top: 20px; font-size: 0.9rem; color: #666; }
        .toggle-link a { color: var(--primary); text-decoration: none; font-weight: bold; cursor: pointer; }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="login-card">
        <img src="aranha-logo.png" class="logo" alt="Logo">
        <h2 id="pageTitle">Bem-vindo</h2>
        <p id="pageSubtitle">Entre para acessar suas reservas.</p>

        <form id="authForm">
            <div class="form-group hidden" id="nameGroup">
                <label>Nome Completo</label>
                <input type="text" id="fullName" placeholder="Seu nome">
            </div>

            <div class="form-group">
                <label>E-mail</label>
                <input type="email" id="email" placeholder="seu@email.com" required>
            </div>

            <div class="form-group">
                <label>Senha</label>
                <input type="password" id="password" placeholder="******" required>
            </div>

            <button type="submit" class="btn-login" id="submitBtn">Entrar</button>
        </form>

        <div class="divider"><span>OU</span></div>

        <button onclick="loginWithGoogle()" class="btn-google">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="G">
            Continuar com Google
        </button>

        <div class="toggle-link">
            <span id="toggleText">Não tem conta?</span> 
            <a onclick="toggleMode()" id="toggleBtn">Cadastre-se</a>
        </div>
        
        <div style="margin-top: 20px;">
            <a href="index.html" style="text-decoration: none; color: #999; font-size: 0.8rem;">&larr; Voltar ao site</a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rfgijfpokictktdrenbl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZ2lqZnBva2ljdGt0ZHJlbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTYyNjUsImV4cCI6MjA3ODQzMjI2NX0.xvQBUxEtH8pad25fac6lDU4WbD-fI3L6BcRO9bsO0GE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isLoginMode = true;

        function toggleMode() {
            isLoginMode = !isLoginMode;
            const title = document.getElementById('pageTitle');
            const sub = document.getElementById('pageSubtitle');
            const btn = document.getElementById('submitBtn');
            const toggleText = document.getElementById('toggleText');
            const toggleBtn = document.getElementById('toggleBtn');
            const nameGroup = document.getElementById('nameGroup');

            if (isLoginMode) {
                title.innerText = 'Bem-vindo'; sub.innerText = 'Entre para acessar suas reservas.'; btn.innerText = 'Entrar';
                toggleText.innerText = 'Não tem conta?'; toggleBtn.innerText = 'Cadastre-se';
                nameGroup.classList.add('hidden'); document.getElementById('fullName').required = false;
            } else {
                title.innerText = 'Criar Conta'; sub.innerText = 'Preencha seus dados para começar.'; btn.innerText = 'Cadastrar';
                toggleText.innerText = 'Já tem conta?'; toggleBtn.innerText = 'Fazer Login';
                nameGroup.classList.remove('hidden'); document.getElementById('fullName').required = true;
            }
        }

        // LÓGICA CENTRAL DE REDIRECIONAMENTO
        function handleRedirect() {
            // 1. Verifica se tem reserva pendente (Prioridade Máxima)
            const pending = localStorage.getItem('pendingAgendaId');
            if (pending) {
                window.location.href = 'index.html'; // Volta para pagar
                return;
            }

            // 2. Verifica se tem intenção de postar foto
            const redirectPost = localStorage.getItem('redirectAfterLogin');
            if (redirectPost) {
                localStorage.removeItem('redirectAfterLogin');
                window.location.href = redirectPost; // Vai pro dashboard/estudio
                return;
            }

            // 3. Padrão: Vai para o Dashboard
            window.location.href = 'dashboard.html';
        }

        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const fullName = document.getElementById('fullName').value;
            const btn = document.getElementById('submitBtn');

            btn.disabled = true; btn.innerText = '...';

            try {
                if (isLoginMode) {
                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    handleRedirect();
                } else {
                    const { error } = await supabase.auth.signUp({
                        email, password, options: { data: { full_name: fullName } }
                    });
                    if (error) throw error;
                    Swal.fire({ icon: 'success', title: 'Sucesso!', showConfirmButton: false, timer: 1500 }).then(() => handleRedirect());
                }
            } catch (error) {
                Swal.fire('Erro', error.message, 'error');
                btn.disabled = false; btn.innerText = isLoginMode ? 'Entrar' : 'Cadastrar';
            }
        });

        async function loginWithGoogle() {
            // Google redireciona sempre para index para processar o estado
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.origin + '/index.html' } 
            });
            if (error) Swal.fire('Erro', error.message, 'error');
        }

        window.onload = async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) handleRedirect();
        };
    </script>
</body>
</html>