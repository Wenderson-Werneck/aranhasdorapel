<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aranhas do Rapel | Aventuras no Espírito Santo</title>
    
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-4T08NL0VVP"></script>
    <script>window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-4T08NL0VVP');</script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

    <style>
        :root {
            --primary: #E83D8A; --secondary: #0055A4; --light: #FDF2F8; 
            --dark: #1A202C; --success: #27ae60; --whatsapp: #25D366;
            --shadow-lg: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        ul, li { list-style: none !important; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body { background-color: var(--light); color: var(--dark); line-height: 1.6; overflow-x: hidden; padding-bottom: 80px; padding-top: 70px; }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; }

        /* HEADER */
        header { background: var(--primary); position: fixed; width: 100%; top: 0; left: 0; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1); height: 70px; display: flex; align-items: center; justify-content: center; }
        .desktop-nav { display: flex; width: 100%; justify-content: center; align-items: center; }
        .nav-links { display: flex; list-style: none; gap: 20px; align-items: center; }
        .nav-links a { color: white; text-decoration: none; font-weight: 600; font-size: 1.0rem; }
        
        /* BOTÃO DE LOGIN / PAINEL (DESTAQUE) */
        .nav-links .btn-login {
            background-color: white; color: var(--primary) !important; padding: 0.8rem 1.8rem !important;
            border-radius: 50px; transition: transform 0.3s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: inline-flex; align-items: center; gap: 8px; font-weight: 800; text-transform: uppercase; font-size: 0.9rem;
        }
        .nav-links .btn-login:hover { transform: translateY(-2px); background-color: #f0f0f0; }

        .fixed-spider { position: fixed; top: 65px; left: 20px; width: 60px; z-index: 900; pointer-events: none; }
        .fixed-spider img { width: 100%; height: auto; display: block; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); }

        .mobile-header-content { display: none; }
        .app-bottom-nav { display: none; }
        .mobile-sidebar { display: none; }
        .sidebar-overlay { display: none; }

        section { padding: 4rem 0; scroll-margin-top: 90px; }
        .section-title { text-align: center; margin-bottom: 3rem; }
        .section-title h2 { font-size: 2.5rem; color: var(--primary); }
        .swipe-hint-text { display: none; }

        .adventures-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 2.5rem; }
        .agenda-grid, .photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 2.5rem; }
        
        .agenda-item, .adventure-card, .photo-item { border-radius: 12px; overflow: hidden; box-shadow: var(--shadow-lg); background: white; cursor: pointer; transition: 0.3s; position: relative; display: flex; flex-direction: column; }
        .agenda-item:hover, .adventure-card:hover { transform: translateY(-5px); }
        .agenda-img, .card-image img { width: 100%; height: auto; object-fit: cover; display: block; }
        .agenda-img { aspect-ratio: 4/5; }
        .card-image { height: 280px; overflow: hidden; }
        .card-image img { height: 100%; transition: 0.4s; }
        .adventure-card:hover .card-image img { transform: scale(1.1); }
        .photo-item .client-img { width: 100%; aspect-ratio: 4/5; object-fit: cover; }

        .agenda-content, .card-content, .photo-content { padding: 1.5rem; flex-grow: 1; text-align: center; }
        .card-content h3 { color: var(--primary); font-size: 1.3rem; text-align: left; }
        .card-meta { display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 1rem; margin-top: auto; }
        .difficulty { padding: 0.3rem 0.8rem; border-radius: 50px; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; }
        .difficulty.facil { background: #e8f5e9; color: var(--success); }
        .difficulty.medio { background: #fff3e0; color: #ff9800; }
        .difficulty.dificil { background: #ffebee; color: #f44336; }
        
        .photo-upload { text-align: center; margin-top: 2rem; }
        .btn-upload { display: inline-flex; gap: 8px; align-items: center; background: var(--primary); color: white; padding: 1rem 2.5rem; border-radius: 50px; text-decoration: none; font-weight: 700; box-shadow: var(--shadow-lg); }
        .swal2-container { z-index: 10000 !important; }

        .modal { display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; padding: 1rem; opacity: 0; visibility: hidden; pointer-events: none; transition: 0.3s; }
        .modal.active { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 1000px; max-height: 90vh; overflow-y: auto; transform: scale(0.98); transition: 0.3s; }
        .modal.active .modal-content { transform: scale(1); }
        .close-modal { position: absolute; top: 25px; right: 30px; font-size: 2.2rem; color: white; cursor: pointer; z-index: 2001; background: rgba(0,0,0,0.5); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid rgba(255,255,255,0.3); }

        .modal-header { position: relative; height: 450px; }
        .modal-header::after { content:''; position: absolute; bottom: 0; left: 0; right: 0; height: 60%; background: linear-gradient(transparent, rgba(0,0,0,0.8)); }
        .modal-header img { width: 100%; height: 100%; object-fit: cover; }
        .modal-header-content { position: absolute; bottom: 0; left: 0; right: 0; color: white; padding: 3rem; z-index: 2; }
        .modal-header-content h2 { font-size: 3rem; color: var(--primary); text-shadow: 2px 2px 4px rgba(0,0,0,0.8); margin-bottom: 0; }
        .modal-body { padding: 3rem; text-align: center; }
        .modal-section { margin-bottom: 3rem; }
        .modal-section h3 { font-size: 1.8rem; color: var(--primary); margin-bottom: 1.5rem; border-bottom: 3px solid var(--accent); display: inline-block; }
        .adventure-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 2rem; }
        .detail-item { background: var(--light); padding: 1.2rem; border-radius: 12px; box-shadow: var(--shadow-lg); border-left: 4px solid var(--accent); }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .gallery-item img { width: 100%; height: 150px; object-fit: cover; border-radius: 12px; }
        
        .agenda-modal-content { max-width: 90%; max-height: 95vh; display: flex; flex-direction: column; align-items: center; background: transparent; box-shadow: none; overflow-y: auto; }
        #agendaModalImage { width: 100%; height: auto; max-width: 550px; max-height: 75vh; object-fit: contain; border-radius: 8px; box-shadow: var(--shadow-lg); display: block; margin: 0 auto; }
        .agenda-actions { display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap; justify-content: center; }
        
        .btn-modal { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 1rem 2rem; border-radius: 50px; text-decoration: none !important; font-weight: 700; box-shadow: var(--shadow-lg); transition: 0.3s; cursor: pointer; color: white !important; opacity: 1 !important; visibility: visible !important; border:none; min-width: 180px; position:relative; z-index:10; }
        .btn-reserve { background-image: linear-gradient(135deg, #e67e22 0%, #d35400 100%) !important; background-color: #e67e22; }
        .btn-whatsapp { background-image: linear-gradient(135deg, var(--whatsapp) 0%, #128C7E 100%) !important; background-color: #25D366; }
        .btn-sector { background-color: #3498db; background-image: none !important; display: none; }
        .btn-reserve:hover, .btn-whatsapp:hover { transform: translateY(-2px); filter: brightness(1.1); }

        footer { background: var(--dark); color: white; padding: 4rem 0 6rem; text-align: center; }
        .social-links { display: flex; gap: 1rem; justify-content: center; margin: 2rem 0; position: relative; z-index: 5; }
        .social-links a { width: 45px; height: 45px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white !important; text-decoration: none; cursor: pointer; pointer-events: auto; }

        @media (max-width: 768px) {
            .desktop-nav { display: none !important; } 
            .mobile-header-content { display: flex; width: 100%; height: 100%; position: relative; justify-content: center; align-items: center; padding: 0 1rem; }
            .header-brand { color: white; font-weight: 800; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
            .menu-toggle { background: none; border: none; color: white; font-size: 1.6rem; position: absolute; right: 15px; }
            
            .mobile-sidebar { display: flex; position: fixed; top: 0; right: -280px; width: 280px; height: 100%; background: white; z-index: 3000; box-shadow: -5px 0 15px rgba(0,0,0,0.2); transition: right 0.3s ease-out; flex-direction: column; }
            .mobile-sidebar.active { right: 0; }
            .sidebar-overlay { display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2999; opacity: 0; visibility: hidden; transition: 0.3s; }
            .sidebar-overlay.active { opacity: 1; visibility: visible; }
            
            .app-bottom-nav { display: flex !important; position: fixed; bottom: 0; left: 0; width: 100%; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; justify-content: space-around; padding: 10px 0 calc(10px + env(safe-area-inset-bottom)); }
            .app-nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: #888; font-size: 0.75rem; font-weight: 600; width: 25%; }
            .app-nav-item.active { color: var(--primary); }
            .app-nav-item i { font-size: 1.4rem; margin-bottom: 4px; }

            .fixed-spider { display: none; }
            header { height: 60px; } 
            .container { width: 100%; padding: 0; }
            .section-title { text-align: left; padding: 0 1rem; margin-bottom: 1.5rem; }
            section { padding: 2.5rem 0; scroll-margin-top: 80px; }
            .swipe-hint-text { display: block; font-size: 0.8rem; color: var(--primary); margin-bottom: 10px; padding: 0 1rem; }
            
            .agenda-grid, .adventures-grid, .photos-grid { display: flex; overflow-x: auto; gap: 1rem; padding: 10px 20px; scrollbar-width: none; }
            .agenda-item, .adventure-card, .photo-item { min-width: 80vw; margin-bottom: 15px; }
            
            .modal-content { border-radius: 20px 20px 0 0; margin-top: auto; max-height: 85vh; }
            .modal-header { height: 250px; }
            .modal-header-content h2 { font-size: 2rem; }
            .close-modal { top: 15px; right: 15px; }
            .agenda-actions { flex-direction: column; }
            .btn-whatsapp, .btn-reserve { width: 100%; }
            #agendaModalImage { max-height: 60vh; }
        }
    </style>
</head>
<body>
    
    <div class="fixed-spider">
        <img src="aranha-logo.png" alt="Aranha">
    </div>

    <div class="mobile-sidebar" id="mobileSidebar">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <button id="closeSidebarBtn" class="close-sidebar">&times;</button>
        </div>
        <div class="sidebar-content">
            <div class="sidebar-login-area" id="sidebarLoginArea">
                <p>Bem-vindo, aventureiro!</p>
                <a href="login.html" class="btn-login-mobile" id="mobileLoginBtn">
                    <i class="fas fa-user"></i> Fazer Login
                </a>
            </div>
            <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 1.5rem;">
            <ul class="sidebar-links">
                <li><a href="#agenda"><i class="fas fa-calendar-alt"></i> Agenda</a></li>
                <li><a href="#adventures"><i class="fas fa-mountain"></i> Aventuras</a></li>
                <li><a href="#client-photos"><i class="fas fa-camera"></i> Mural</a></li>
                <li><a href="#dicas"><i class="fas fa-lightbulb"></i> Dicas &nbsp;<span class="badge-new">Novo</span></a></li>
                <li><a href="#" id="sidebarWhatsapp"><i class="fab fa-whatsapp"></i> Contato</a></li>
            </ul>
        </div>
    </div>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <nav class="app-bottom-nav">
        <a href="#agenda" class="app-nav-item active"><i class="fas fa-calendar-alt"></i><span>Agenda</span></a>
        <a href="#adventures" class="app-nav-item"><i class="fas fa-mountain"></i><span>Aventuras</span></a>
        <a href="#client-photos" class="app-nav-item"><i class="fas fa-camera"></i><span>Mural</span></a>
        <a href="#" id="mobileWhatsappBtn" class="app-nav-item"><i class="fab fa-whatsapp"></i><span>Contato</span></a>
    </nav>

    <header id="mainHeader">
        <div class="container">
            <nav class="desktop-nav">
                <ul class="nav-links" id="navLinks">
                    <li><a href="#agenda">Agenda</a></li>
                    <li><a href="#adventures">Aventuras</a></li>
                    <li><a href="#client-photos">Mural</a></li>
                    <li><a href="#dicas">Dicas</a></li>
                    <li><a href="login.html" class="btn-login" id="desktopLoginBtn"><i class="fas fa-user"></i> Entrar</a></li>
                </ul>
            </nav>
            <div class="mobile-header-content">
                <div class="header-brand">Aranhas do Rapel</div>
                <button id="mobileMenuBtn" class="menu-toggle"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </header>

    <section class="agenda" id="agenda">
        <div class="container">
            <div class="section-title">
                <h2>Agenda</h2>
                <p>Confira as próximas saídas e garanta sua vaga!</p>
                <span class="swipe-hint-text">Arraste para o lado <i class="fas fa-chevron-right"></i></span>
            </div>
            <div class="agenda-grid" id="agendaGrid"></div>
        </div>
    </section>

    <section class="adventures" id="adventures">
        <div class="container">
            <div class="section-title">
                <h2>Nossas Aventuras</h2>
                <p>Descubra os locais incríveis onde vivemos as melhores experiências.</p>
                <span class="swipe-hint-text">Arraste para o lado <i class="fas fa-chevron-right"></i></span>
            </div>
            <div class="adventures-grid" id="adventuresGrid"></div>
        </div>
    </section>

    <section class="client-photos" id="client-photos">
        <div class="container">
            <div class="section-title">
                <h2>Mural dos Aranhas</h2>
                <p>Momentos inesquecíveis de quem já se aventurou conosco.</p>
                <span class="swipe-hint-text">Arraste para o lado <i class="fas fa-chevron-right"></i></span>
            </div>
            <div class="photos-grid" id="photosGrid"></div>
            <div class="photo-upload">
                <a href="#" id="btnSendPhoto" class="btn-upload"><i class="fas fa-camera"></i> Enviar Minha Foto</a>
            </div>
        </div>
    </section>

    <section class="tips" id="dicas" style="background: white;">
        <div class="container">
            <div class="section-title">
                <h2>Dicas de Rapel</h2>
                <p>Prepare-se para sua aventura com nossas recomendações.</p>
            </div>
            <div style="text-align: center; padding: 2rem; background: var(--light); border-radius: 12px;">
                <h3 style="color: var(--primary); margin-bottom: 1rem;"><i class="fas fa-hard-hat"></i> Segurança em Primeiro Lugar</h3>
                <p>Em breve postaremos dicas exclusivas sobre equipamentos, vestimentas e preparação física!</p>
            </div>
        </div>
    </section>

    <div class="modal" id="adventureModal">
        <div class="close-modal" id="closeModal">&times;</div>
        <div class="modal-content">
            <div class="modal-header">
                <img id="modalImage" src="" alt="">
                <div class="modal-header-content"><h2 id="modalTitle"></h2><p id="modalSubtitle" style="display:none!important"></p></div>
            </div>
            <div class="modal-body">
                <div class="modal-section"><h3>Detalhes</h3><div class="adventure-details" id="adventureDetails"></div></div>
                <div class="modal-section"><h3>Descrição</h3><p id="adventureDescription"></p></div>
                <div class="modal-section"><h3>Galeria</h3><div class="gallery" id="adventureGallery"></div></div>
                <div class="modal-section modal-buttons-row">
                    <a href="#" class="btn-modal btn-reserve" id="reserveButton" style="display:none!important"><i class="fas fa-ticket-alt"></i> Reservar Vaga</a>
                    <a href="#" class="btn-modal btn-whatsapp" id="whatsappButton" target="_blank"><i class="fab fa-whatsapp"></i> Saiba mais</a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="agendaModal">
        <div class="close-modal" id="closeAgendaModal">&times;</div>
        <div class="agenda-modal-content">
            <img id="agendaModalImage" src="" alt="">
            <div class="agenda-actions">
                <button class="btn-modal btn-reserve" id="btnReserveSpot"><i class="fas fa-ticket-alt"></i> Reservar Vaga</button>
                <a href="#" class="btn-modal btn-whatsapp" id="agendaModalButton" target="_blank"><i class="fab fa-whatsapp"></i> Falar com Equipe</a>
                <a href="#" class="btn-modal btn-sector" id="agendaSectorBtn" style="display:none!important"><i class="fas fa-map-marked-alt"></i> Ver Setor</a>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <img src="social-share.jpg" class="footer-logo-img">
                <p>Segurança, Adrenalina e Conexão com a Natureza.</p>
                <div class="social-links">
                    <a href="https://www.facebook.com/aranhas.rapel" target="_blank"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com/aranhas.rapel/" target="_blank"><i class="fab fa-instagram"></i></a>
                    <a href="https://www.tiktok.com/@aranhasdorapel?_r=1&_t=ZS-91GP46a5JG3" target="_blank"><i class="fab fa-tiktok"></i></a>
                    <a href="#" id="footerWhatsapp"><i class="fab fa-whatsapp"></i></a>
                </div>
                <p class="copyright">&copy; 2025 Aranhas do Rapel. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        const SUPABASE_URL = 'https://rfgijfpokictktdrenbl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZ2lqZnBva2ljdGt0ZHJlbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTYyNjUsImV4cCI6MjA3ODQzMjI2NX0.xvQBUxEtH8pad25fac6lDU4WbD-fI3L6BcRO9bsO0GE';
        const whatsappNumber = '5527995335559';
        const MP_PUBLIC_KEY = 'APP_USR-e0f74881-fec0-4f1a-9aaf-44313bd17b04';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const mp = new MercadoPago(MP_PUBLIC_KEY);
        const CACHE_KEY = 'aranhas_data_v1';
        const CACHE_EXPIRY = 15 * 60 * 1000;

        // AUTH CHECK & REDIRECT LOGIC
        async function checkLoginState() {
            const { data: { session } } = await supabase.auth.getSession();
            const isRedirect = location.hash && location.hash.includes('access_token');
            
            if (session) {
                currentUser = session.user;
                
                // 1. Atualiza Botão Desktop
                const dBtn = document.getElementById('desktopLoginBtn');
                if(dBtn) { dBtn.href = 'dashboard.html'; dBtn.innerHTML = 'ACESSAR PAINEL'; }

                // 2. Atualiza Sidebar Mobile
                const sidebarArea = document.getElementById('sidebarLoginArea');
                const avatarUrl = currentUser.user_metadata.avatar_url || `https://ui-avatars.com/api/?name=${currentUser.email}&background=E83D8A&color=fff`;
                const name = currentUser.user_metadata.full_name || 'Aventureiro';
                sidebarArea.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; gap:10px;"><img src="${avatarUrl}" style="width:70px; height:70px; border-radius:50%; object-fit:cover; border:3px solid var(--primary);"><div style="text-align:center;"><strong style="display:block; font-size:1.1rem; color:var(--dark);">${name}</strong><a href="dashboard.html" style="color:var(--primary); font-weight:bold; font-size:0.9rem;">Acessar Painel <i class="fas fa-arrow-right"></i></a></div></div>`;

                // 3. Lógica de Redirecionamento (Prioridades)
                const pending = localStorage.getItem('pendingAgendaId');
                
                if (pending) {
                    // Se tem reserva pendente, abre o modal dela
                    const item = allAgenda.find(i => i.id == pending);
                    if(item) { openAgendaModal(item); localStorage.removeItem('pendingAgendaId'); }
                } else if (isRedirect) {
                    // Se veio do Google/Email link e não tem reserva, vai pro Dashboard
                    window.location.href = 'dashboard.html';
                }
            }
        }

        // ... RESTO DO CÓDIGO (Igual ao anterior, sem mudanças na lógica de negócio) ...
        
        function renderSkeleton(id,c){const d=document.getElementById(id);d.innerHTML='';for(let i=0;i<c;i++)d.innerHTML+=`<div class="sk-card skeleton"><div class="sk-img skeleton"></div><div class="sk-content"><div class="sk-title skeleton"></div><div class="sk-text skeleton"></div></div></div>`;}
        async function loadDataWithCache(){
            const c=localStorage.getItem(CACHE_KEY); if(c){const j=JSON.parse(c);if(Date.now()-j.timestamp<CACHE_EXPIRY){renderAll(j.data);checkLoginState();return;}}
            renderSkeleton('agendaGrid',4); renderSkeleton('adventuresGrid',4); renderSkeleton('photosGrid',4);
            try{
                const [ag,ad,mu]=await Promise.all([supabase.from('agenda').select('*').order('display_order',{ascending:true}),supabase.from('aventuras').select('*').order('created_at',{ascending:false}),supabase.from('mural').select('*').eq('status','approved').order('created_at',{ascending:false})]);
                const data={agenda:ag.data||[],adventures:ad.data||[],mural:mu.data||[]};
                localStorage.setItem(CACHE_KEY,JSON.stringify({timestamp:Date.now(),data})); renderAll(data); checkLoginState();
            }catch(e){console.error(e);}
        }
        
        let allAdventures=[], allAgenda=[], currentUser=null, currentAgendaItem=null;
        function renderAll(d){ allAdventures=d.adventures; allAgenda=d.agenda; renderAgenda(d.agenda); renderAdventures(d.adventures); renderMural(d.mural); }
        
        function renderAgenda(l){const g=document.getElementById('agendaGrid');g.innerHTML='';l.forEach(i=>{const c=document.createElement('div');c.className='agenda-item';const p=i.price?`<span style="color:#27ae60;font-weight:bold;display:block;margin-top:5px">R$ ${i.price}</span>`:'';c.innerHTML=`<img src="${i.image_url}" class="agenda-img" loading="lazy"><div class="agenda-content"><h4>${i.title}</h4><p>${i.date_text}</p>${p}</div>`;c.onclick=()=>openAgendaModal(i);g.appendChild(c);});}
        function renderAdventures(l){const g=document.getElementById('adventuresGrid');g.innerHTML='';l.forEach(i=>{const c=document.createElement('div');c.className='adventure-card';c.innerHTML=`<div class="card-image"><img src="${i.image_url}" loading="lazy"></div><div class="card-content"><h3>${i.title}</h3><div class="card-meta"><span class="difficulty ${i.difficulty}">${i.difficulty}</span></div></div>`;c.onclick=()=>openAdventureModal(i);g.appendChild(c);});}
        function renderMural(l){const g=document.getElementById('photosGrid');g.innerHTML='';l.forEach(i=>{const c=document.createElement('div');c.className='photo-item';c.innerHTML=`<img src="${i.image_url}" class="client-img" loading="lazy"><div class="photo-content"><h4>${i.title}</h4><small>by ${i.author}</small></div>`;g.appendChild(c);});}

        // MODALS
        const am=document.getElementById('adventureModal'), gm=document.getElementById('agendaModal');
        function openModal(e){e.classList.add('active');document.body.style.overflow='hidden';history.pushState({m:true},"",location.href);}
        function closeModal(e){e.classList.remove('active');document.body.style.overflow='auto';}
        window.onpopstate=()=>{closeModal(am);closeModal(gm);};
        document.getElementById('closeModal').onclick=()=>closeModal(am); document.getElementById('closeAgendaModal').onclick=()=>closeModal(gm);

        function openAgendaModal(i){
            currentAgendaItem=i; document.getElementById('agendaModalImage').src=i.image_url;
            document.getElementById('agendaModalButton').href=`https://wa.me/${whatsappNumber}?text=Dúvida: ${i.title}`;
            const rel=allAdventures.find(a=>a.id===i.adventure_id);
            const sb=document.getElementById('agendaSectorBtn');
            if(rel){sb.style.setProperty('display','inline-flex','important'); sb.onclick=(e)=>{e.preventDefault();closeModal(gm);setTimeout(()=>openAdventureModal(rel),100);}}
            else sb.style.setProperty('display','none','important');
            openModal(gm);
        }

        function openAdventureModal(a){
            document.querySelector('#adventureModal .modal-content').scrollTop=0;
            document.getElementById('modalTitle').textContent=a.title; document.getElementById('modalImage').src=a.image_url; document.getElementById('adventureDescription').textContent=a.description;
            document.getElementById('whatsappButton').href=`https://wa.me/${whatsappNumber}?text=Info: ${a.title}`;
            const ev=allAgenda.find(i=>i.adventure_id===a.id);
            const rb=document.getElementById('reserveButton');
            if(ev){rb.style.setProperty('display','inline-flex','important'); rb.onclick=(e)=>{e.preventDefault();closeModal(am);setTimeout(()=>openAgendaModal(ev),100);}}
            else rb.style.setProperty('display','none','important');
            
            const dt=document.getElementById('adventureDetails'); dt.innerHTML='';
            if(a.details) a.details.forEach(d=>dt.innerHTML+=`<div class="detail-item"><h4>${d.label}</h4><p>${d.value}</p></div>`);
            const gl=document.getElementById('adventureGallery'); gl.innerHTML='';
            (a.gallery_images||[a.image_url]).forEach(u=>gl.innerHTML+=`<div class="gallery-item"><img src="${u}"></div>`);
            openModal(am);
        }

        document.getElementById('btnSendPhoto').onclick=(e)=>{
            e.preventDefault(); 
            if(currentUser) window.location.href='dashboard.html?section=estudio';
            else { localStorage.setItem('redirectAfterLogin','dashboard.html?section=estudio'); Swal.fire({title:'Faça Login', text:'Necessário para postar.', confirmButtonColor:'#E83D8A'}).then(()=>location.href='login.html'); }
        };

        // PAGAMENTO
        document.getElementById('btnReserveSpot').onclick=async()=>{
            if(!currentUser){ localStorage.setItem('pendingAgendaId', currentAgendaItem.id); location.href='login.html'; return; }
            Swal.fire({title:'Confirmar Reserva', html:`Evento: <b>${currentAgendaItem.title}</b><br>R$ ${currentAgendaItem.price}`, showCancelButton:true, confirmButtonText:'Pagar PIX', confirmButtonColor:'#E83D8A'}).then(async(r)=>{
                if(r.isConfirmed){
                    const {data:b}=await supabase.from('bookings').insert([{user_id:currentUser.id, agenda_id:currentAgendaItem.id, status:'pendente', amount:currentAgendaItem.price}]).select().single();
                    Swal.fire({title:'Gerando PIX...', didOpen:()=>Swal.showLoading()});
                    try{
                        const res=await fetch("https://api.aranhasdorapel.com.br/webhook/gerar-pix",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transaction_amount:parseFloat(currentAgendaItem.price),description:`Reserva: ${currentAgendaItem.title}`,payer:{email:currentUser.email}})});
                        const d=await res.json();
                        if(d.point_of_interaction){
                            await supabase.from('bookings').update({payment_id:d.id.toString()}).eq('id',b.id);
                            const c=d.point_of_interaction.transaction_data.qr_code, b64=d.point_of_interaction.transaction_data.qr_code_base64;
                            Swal.fire({title:'Pagamento PIX', html:`<img src="data:image/png;base64,${b64}" style="width:200px;display:block;margin:auto"><textarea style="width:100%" readonly>${c}</textarea>`, confirmButtonText:'Enviar Comprovante', confirmButtonColor:'#25D366'}).then((x)=>{if(x.isConfirmed) window.open(`https://wa.me/${whatsappNumber}?text=Paguei reserva ${currentAgendaItem.title}`,'_blank')});
                        } else throw new Error();
                    }catch{Swal.fire('Erro','Tente novamente','error');}
                }
            });
        };

        // SIDEBAR
        const mb=document.getElementById('mobileMenuBtn'), sb=document.getElementById('mobileSidebar'), ov=document.getElementById('sidebarOverlay'), cb=document.getElementById('closeSidebarBtn');
        function tS(){sb.classList.toggle('active');ov.classList.toggle('active');}
        if(mb)mb.onclick=tS; if(cb)cb.onclick=tS; if(ov)ov.onclick=tS;

        window.onscroll=()=>{
            const s=document.querySelectorAll('section'), n=document.querySelectorAll('.app-nav-item');
            let c=''; s.forEach(x=>{if(scrollY>=(x.offsetTop-150))c=x.getAttribute('id')});
            n.forEach(i=>{i.classList.remove('active'); if(i.href.includes(c))i.classList.add('active')});
        };

        const wl=`https://wa.me/${whatsappNumber}`;
        document.getElementById('footerWhatsapp').href=wl; document.getElementById('mobileWhatsappBtn').href=wl; document.getElementById('sidebarWhatsapp').href=wl;

        document.addEventListener('DOMContentLoaded', loadDataWithCache);
    </script>
</body>
</html>