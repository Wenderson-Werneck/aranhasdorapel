<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Aranhas do Rapel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #E83D8A; --secondary: #0055A4; --light: #FDF2F8; --dark: #1A202C; --danger: #e53e3e; --success: #27ae60; --radius: 12px; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding-bottom: 80px; }
        .container { width: 95%; max-width: 1200px; margin: 2rem auto; }
        button { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 50px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button.danger { background: var(--danger); } button.success { background: var(--success); } button.secondary { background: var(--secondary); }
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 8px; }
        .admin-layout { display: none; }
        .auth-screen { text-align: center; padding: 3rem; background: white; max-width: 400px; margin: 5rem auto; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 2rem; border-radius: var(--radius); margin-bottom: 2rem; }
        
        /* LISTAS */
        .admin-list { background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 2rem; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; }
        .item:last-child { border-bottom: none; }
        .item-info { display: flex; align-items: center; gap: 1rem; }
        .item-info img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
        .item-actions { display: flex; gap: 5px; }
        
        /* DESTAQUE PENDENTE */
        .item.pending { background-color: #fff8e1; border-left: 4px solid #ffc107; }
        
        .code-box { background: #2d3748; color: #48bb78; font-family: monospace; font-size: 1.5rem; padding: 15px; border-radius: 8px; text-align: center; display: none; margin-top:10px; }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-screen">
        <h2>Admin Acesso</h2>
        <form id="loginForm">
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Senha" required>
            <button type="submit" style="width:100%">Entrar</button>
        </form>
    </div>

    <div id="adminLayout" class="admin-layout container">
        <div class="admin-header"><h1>Painel de Controle</h1><button onclick="logout()" class="danger">Sair</button></div>

        <section>
            <h2 style="color:var(--secondary)"><i class="fas fa-camera-retro"></i> Moderação do Mural</h2>
            
            <div class="admin-list">
                <h3 style="color:#e67e22; border-bottom:1px solid #eee; padding-bottom:10px;">⏳ Pendentes de Aprovação</h3>
                <div id="pendingMuralList"><p>Nenhuma foto pendente.</p></div>
            </div>

            <div class="admin-list">
                <h3 style="color:var(--success); border-bottom:1px solid #eee; padding-bottom:10px;">✅ No Ar (Site Principal)</h3>
                <div id="activeMuralList"><p>Carregando...</p></div>
            </div>
        </section>

        <hr style="margin:3rem 0; border:0; border-top:1px dashed #ccc;">

        <section>
            <h2>Gerar Código de Badge</h2>
            <div style="background:white; padding:1.5rem; border-radius:12px;">
                <div style="display:flex; gap:10px;">
                    <select id="manualBadgeSelect"><option>Carregando...</option></select>
                    <button onclick="generateCode()" class="success">Gerar</button>
                </div>
                <div id="generatedCodeDisplay" class="code-box"></div>
            </div>
        </section>
        
        </div>

    <script>
        const SUPABASE_URL = 'https://rfgijfpokictktdrenbl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZ2lqZnBva2ljdGt0ZHJlbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTYyNjUsImV4cCI6MjA3ODQzMjI2NX0.xvQBUxEtH8pad25fac6lDU4WbD-fI3L6BcRO9bsO0GE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // AUTH
        checkAuth();
        async function checkAuth() { const {data:{session}} = await supabase.auth.getSession(); if(session){ document.getElementById('authScreen').style.display='none'; document.getElementById('adminLayout').style.display='block'; loadAllData(); } }
        document.getElementById('loginForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const {error} = await supabase.auth.signInWithPassword({email:document.getElementById('loginEmail').value, password:document.getElementById('loginPassword').value}); if(!error) location.reload(); else alert(error.message); });
        window.logout = async()=>{ await supabase.auth.signOut(); location.reload(); };

        // DATA LOADING
        async function loadAllData() {
            loadBadgesSelect();
            loadMuralData();
        }

        async function loadMuralData() {
            // Busca TUDO (sem filtro de status, pois o admin vê tudo)
            const { data, error } = await supabase.from('mural').select('*').order('created_at', {ascending:false});
            
            const pendingDiv = document.getElementById('pendingMuralList');
            const activeDiv = document.getElementById('activeMuralList');
            pendingDiv.innerHTML = ''; activeDiv.innerHTML = '';

            if(data) {
                let hasPending = false;
                data.forEach(item => {
                    // HTML do Item
                    const html = `
                        <div class="item ${item.status === 'pending' ? 'pending' : ''}">
                            <div class="item-info">
                                <img src="${item.image_url}" onclick="window.open('${item.image_url}')" style="cursor:zoom-in">
                                <div>
                                    <strong>${item.author}</strong> <span style="font-size:0.8rem; color:#666">(${item.title})</span><br>
                                    <small>"${item.quote}"</small>
                                </div>
                            </div>
                            <div class="item-actions">
                                ${item.status === 'pending' 
                                    ? `<button class="success" onclick="approve('${item.id}')" title="Aprovar"><i class="fas fa-check"></i></button>
                                       <button class="danger" onclick="remove('${item.id}')" title="Rejeitar"><i class="fas fa-times"></i></button>` 
                                    : `<button class="danger" onclick="remove('${item.id}')" title="Remover do Site"><i class="fas fa-trash"></i></button>`
                                }
                            </div>
                        </div>`;

                    if(item.status === 'pending') {
                        pendingDiv.innerHTML += html;
                        hasPending = true;
                    } else if(item.status === 'approved') {
                        activeDiv.innerHTML += html;
                    }
                });
                if(!hasPending) pendingDiv.innerHTML = '<p style="color:#999">Nada pendente.</p>';
            }
        }

        // AÇÕES DE CONTROLE
        window.approve = async (id) => {
            if(confirm('Aprovar esta foto? Ela aparecerá no site.')) {
                await supabase.from('mural').update({ status: 'approved' }).eq('id', id);
                loadMuralData();
            }
        };

        window.remove = async (id) => {
            if(confirm('Tem certeza? Isso apagará a postagem.')) {
                await supabase.from('mural').delete().eq('id', id);
                loadMuralData();
            }
        };

        // EXTRAS (Badges)
        async function loadBadgesSelect() {
            const { data } = await supabase.from('aventuras').select('id, title');
            const sel = document.getElementById('manualBadgeSelect');
            sel.innerHTML = '';
            data.forEach(b => sel.innerHTML += `<option value="${b.id}">${b.title}</option>`);
        }
        window.generateCode = async () => {
            const id = document.getElementById('manualBadgeSelect').value;
            const code = `ARANHA-${Math.random().toString(36).substring(2,6).toUpperCase()}`;
            await supabase.from('redeem_codes').insert([{code, adventure_id:id}]);
            document.getElementById('generatedCodeDisplay').style.display='block';
            document.getElementById('generatedCodeDisplay').innerText = code;
        };

    </script>
</body>
</html>