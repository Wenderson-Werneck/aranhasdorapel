<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Aranhas do Rapel</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #E83D8A;
            --secondary: #0055A4;
            --light: #FDF2F8;
            --white: #ffffff;
            --dark: #1A202C;
            --danger: #e53e3e;
            --success: #27ae60;
            --radius: 12px;
        }

        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding: 0; padding-bottom: 80px; }
        .container { width: 95%; max-width: 1200px; margin: 2rem auto; }
        
        button { 
            background: var(--primary); color: white; border: none; padding: 12px 20px; 
            border-radius: 50px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; 
        }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button.danger { background: var(--danger); }
        button.secondary { background: var(--secondary); }
        button.success { background: var(--success); }
        button.outline { background: transparent; border: 2px solid #ccc; color: #666; }

        input, textarea, select {
            width: 100%; padding: 12px; margin: 8px 0 16px 0;
            border: 1px solid #ddd; border-radius: 8px; background: #fafafa;
        }
        
        form { background: var(--white); padding: 2rem; border-radius: var(--radius); border-top: 4px solid var(--primary); }
        .admin-layout { display: none; }
        .auth-screen { text-align: center; padding: 3rem; background: var(--white); max-width: 400px; margin: 5rem auto; border-top: 5px solid var(--primary); }
        
        .admin-header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: white; padding: 1rem 2rem; border-radius: var(--radius); margin-bottom: 2rem;
        }
        
        .admin-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem; }
        .admin-list { background: white; padding: 1.5rem; border-radius: var(--radius); }
        
        .item { background: #fff; border-bottom: 1px solid #eee; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; }
        .item-info { display: flex; align-items: center; gap: 1rem; }
        .item-info img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
        
        /* BOX DO CÓDIGO */
        .code-box {
            background: #2d3748; color: #48bb78; font-family: 'Courier New', monospace;
            font-size: 2rem; padding: 20px; border-radius: 10px; text-align: center;
            letter-spacing: 5px; font-weight: bold; margin-top: 20px; display: none;
            border: 2px dashed #48bb78;
        }

        .loader { text-align: center; padding: 2rem; }

        @media (max-width: 768px) { .admin-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-screen">
        <h2>Admin Aranhas</h2>
        <form id="loginForm">
            <input type="email" id="loginEmail" placeholder="Email">
            <input type="password" id="loginPassword" placeholder="Senha">
            <button type="submit" style="width:100%">Entrar</button>
        </form>
    </div>

    <div id="adminLayout" class="admin-layout container">
        <div class="admin-header">
            <h1>Painel de Controle</h1>
            <button id="logoutButton" class="danger">Sair</button>
        </div>
        
        <section style="margin-bottom: 3rem; background: #e3f2fd; padding: 2rem; border-radius: 12px; border: 2px dashed #90caf9;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem;">
                <i class="fas fa-magic" style="color: var(--secondary); font-size: 1.5rem;"></i>
                <h2 style="margin:0; color: var(--secondary);">Gerar Código de Resgate</h2>
            </div>
            <p style="margin-bottom: 1rem;">Gere um código único para o cliente resgatar o badge no painel dele.</p>
            
            <form id="codeGenForm" style="box-shadow: none; border: none; padding: 0; background: transparent;">
                <div style="display: flex; gap: 10px; align-items: flex-end;">
                    <div style="flex: 1;">
                        <label>Escolher Aventura (Badge)</label>
                        <select id="manualBadgeSelect" required style="margin-bottom:0;"></select>
                    </div>
                    <button type="submit" class="success" style="height: 48px; margin-bottom: 0;">
                        <i class="fas fa-bolt"></i> Gerar Código
                    </button>
                </div>
            </form>

            <div id="generatedCodeDisplay" class="code-box"></div>
        </section>

        <section>
            <h2>Gerenciar Agenda</h2>
            <div class="admin-grid">
                <form id="agendaForm">
                    <h3>Adicionar Evento</h3>
                    <input type="hidden" id="agendaId">
                    <input type="text" id="agendaTitle" placeholder="Título" required>
                    <select id="agendaAdventureId"><option value="">-- Vincular Aventura --</option></select>
                    <input type="text" id="agendaDate" placeholder="Data/Hora" required>
                    <input type="number" id="agendaPrice" placeholder="Preço" step="0.01" required>
                    <input type="text" id="agendaImage" placeholder="Imagem URL" required>
                    <button type="submit">Salvar Evento</button>
                    <button type="button" id="cancelEditAgenda" class="outline" style="display:none;">Cancelar</button>
                </form>
                <div class="admin-list" id="agendaList">Carregando...</div>
            </div>
        </section>

        <br><hr><br>
        <p style="text-align:center; color:#999;">Gerenciamento de Aventuras e Mural disponível abaixo</p>
    </div>

    <script>
        const SUPABASE_URL = 'https://rfgijfpokictktdrenbl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZ2lqZnBva2ljdGt0ZHJlbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTYyNjUsImV4cCI6MjA3ODQzMjI2NX0.xvQBUxEtH8pad25fac6lDU4WbD-fI3L6BcRO9bsO0GE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Elementos
        const agendaList = document.getElementById('agendaList');
        const manualBadgeSelect = document.getElementById('manualBadgeSelect');
        const agendaAdventureSelect = document.getElementById('agendaAdventureId');
        const codeDisplay = document.getElementById('generatedCodeDisplay');

        // AUTH
        checkAuth();
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) { 
                document.getElementById('authScreen').style.display = 'none'; 
                document.getElementById('adminLayout').style.display = 'block'; 
                loadData(); 
            }
        }
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { error } = await supabase.auth.signInWithPassword({ 
                email: document.getElementById('loginEmail').value, 
                password: document.getElementById('loginPassword').value 
            });
            if (!error) location.reload();
            else alert(error.message);
        });

        document.getElementById('logoutButton').addEventListener('click', async () => {
             await supabase.auth.signOut();
             location.reload();
        });

        // LOAD DATA
        async function loadData() {
            // Carrega Aventuras para os Selects
            const { data: advs } = await supabase.from('aventuras').select('id, title');
            if(advs) {
                manualBadgeSelect.innerHTML = '<option value="">-- Selecione --</option>';
                agendaAdventureSelect.innerHTML = '<option value="">-- Selecione --</option>';
                advs.forEach(a => {
                    const opt = `<option value="${a.id}">${a.title}</option>`;
                    manualBadgeSelect.innerHTML += opt;
                    agendaAdventureSelect.innerHTML += opt;
                });
            }
            // Carrega Agenda
            loadAgenda();
        }

        async function loadAgenda() {
            const { data } = await supabase.from('agenda').select('*').order('display_order');
            agendaList.innerHTML = '';
            if(data) {
                data.forEach(item => {
                    const el = document.createElement('div'); el.className = 'item';
                    el.innerHTML = `
                        <div class="item-info">
                            <img src="${item.image_url}">
                            <div><strong>${item.title}</strong><br><small>${item.date_text}</small></div>
                        </div>
                        <div>
                            <button class="danger" onclick="deleteAgenda('${item.id}')"><i class="fas fa-trash"></i></button>
                        </div>`;
                    agendaList.appendChild(el);
                });
            }
        }

        // --- GERADOR DE CÓDIGO ---
        document.getElementById('codeGenForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const advId = manualBadgeSelect.value;
            if(!advId) return alert('Selecione uma aventura');

            // Gera código aleatório (Ex: ARANHA-X9Y2)
            const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
            const code = `ARANHA-${randomPart}`;

            // Salva no banco
            const { error } = await supabase.from('redeem_codes').insert([{
                code: code,
                adventure_id: advId
            }]);

            if(error) {
                alert('Erro: ' + error.message);
            } else {
                codeDisplay.style.display = 'block';
                codeDisplay.innerHTML = `${code} <br><small style="font-size:12px; color:#fff;">Copie e envie para o cliente</small>`;
            }
        });

        // --- AGENDA SIMPLES ---
        document.getElementById('agendaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                title: document.getElementById('agendaTitle').value,
                adventure_id: document.getElementById('agendaAdventureId').value || null,
                date_text: document.getElementById('agendaDate').value,
                price: document.getElementById('agendaPrice').value,
                image_url: document.getElementById('agendaImage').value
            };
            await supabase.from('agenda').insert([data]);
            document.getElementById('agendaForm').reset();
            loadAgenda();
        });

        window.deleteAgenda = async (id) => {
            if(confirm('Apagar?')) {
                await supabase.from('agenda').delete().eq('id', id);
                loadAgenda();
            }
        }
    </script>
</body>
</html>