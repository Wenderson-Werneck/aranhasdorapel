<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Aranhas do Rapel</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --primary: #E83D8A; --secondary: #0055A4; --light: #FDF2F8; --white: #ffffff; --dark: #1A202C; --danger: #e53e3e; --success: #27ae60; --radius: 12px; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding-bottom: 80px; }
        .container { width: 95%; max-width: 1200px; margin: 2rem auto; }
        
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button.danger { background: var(--danger); } button.secondary { background: var(--secondary); } button.success { background: var(--success); }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0 16px 0; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        form { background: var(--white); padding: 2rem; border-radius: var(--radius); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border-top: 4px solid var(--primary); margin-bottom: 2rem; }
        label { font-weight: 600; display: block; color: var(--secondary); font-size: 0.9rem; margin-top: 0.5rem;}
        
        .upload-group { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; margin-top: 5px; }
        .status-indicator { flex: 1; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; background: #f1f5f9; border: 1px dashed #cbd5e1; color: #64748b; }
        .status-indicator.success { background: #dcfce7; border-color: var(--success); color: var(--success); font-weight: bold; }
        .file-label { background: var(--secondary); color: white; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-weight: bold; }
        input[type="file"] { display: none; }

        .admin-layout { display: none; }
        .auth-screen { text-align: center; padding: 3rem; background: var(--white); border-radius: var(--radius); max-width: 400px; margin: 5rem auto; border-top: 5px solid var(--primary); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 2rem; border-radius: var(--radius); margin-bottom: 2rem; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem; }
        
        /* BADGE MANAGER STYLE */
        .badge-preview { width: 100px; height: 100px; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; margin: 10px auto; border-radius: 12px; background: #eee; }
        .badge-preview img { width: 100%; height: 100%; object-fit: contain; }

        .item { background: #fff; border-bottom: 1px solid #eee; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; }
        .item-info { display: flex; align-items: center; gap: 1rem; }
        .item-info img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
        .code-box { background: #2d3748; color: #48bb78; font-family: monospace; font-size: 1.5rem; padding: 15px; border-radius: 8px; text-align: center; display: none; margin-top:10px; }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-screen">
        <h2 style="color:var(--primary)">Admin Acesso</h2>
        <form id="loginForm" style="box-shadow: none; padding: 0; border: none;">
            <input type="email" id="loginEmail" placeholder="Email" required>
            <input type="password" id="loginPassword" placeholder="Senha" required>
            <button type="submit" style="width:100%; margin-top:1rem;">Entrar</button>
        </form>
    </div>

    <div id="adminLayout" class="admin-layout container">
        <div class="admin-header">
            <h1><i class="fas fa-spider" style="color:var(--primary)"></i> Painel Admin</h1>
            <button id="logoutButton" class="danger">Sair</button>
        </div>

        <section style="background: #fff0f5; padding: 2rem; border-radius: 12px; border: 2px solid #E83D8A; margin-bottom: 3rem;">
            <h2 style="color:var(--primary); margin-top:0;"><i class="fas fa-medal"></i> Cadastrar Badges Oficiais</h2>
            <p style="color:#666; font-size:0.9rem;">Vincule um arquivo PNG (Fundo Transparente) para cada setor.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start;">
                <form id="badgeForm" style="margin:0; box-shadow:none; border:none; padding:0; background:transparent;">
                    <label>1. Escolha o Setor (Aventura)</label>
                    <select id="badgeSectorSelect" onchange="checkExistingBadge()" required>
                        <option value="">Carregando...</option>
                    </select>

                    <label>2. Nome do Badge (Opcional - altera o t√≠tulo do setor)</label>
                    <input type="text" id="badgeNameInput" placeholder="Ex: Conquistador do Moreno">

                    <label>3. Upload do Arquivo (PNG)</label>
                    <div class="upload-group">
                        <input type="hidden" id="badgeImageUrl" required>
                        <div id="badgeImageStatus" class="status-indicator"><i class="fas fa-image"></i> Aguardando...</div>
                        <label class="file-label">Escolher PNG <input type="file" accept="image/png" onchange="uploadBadgeFile(this)"></label>
                    </div>

                    <button type="submit" class="success" style="width:100%; justify-content:center; margin-top:10px;">
                        <i class="fas fa-save"></i> Salvar Badge Oficial
                    </button>
                </form>

                <div style="text-align: center; background: white; padding: 20px; border-radius: 12px; border: 1px solid #ddd;">
                    <label>Pr√©-visualiza√ß√£o</label>
                    <div class="badge-preview" id="badgePreviewBox">
                        <span style="color:#ccc; font-size:0.8rem;">Sem imagem</span>
                    </div>
                    <p id="badgeCurrentStatus" style="font-size:0.8rem; color:#666;">Selecione um setor para ver o badge atual.</p>
                </div>
            </div>
        </section>

        <hr style="margin: 3rem 0; border:0; border-top:1px dashed #ccc;">

        <section>
            <h2>Mural (Modera√ß√£o)</h2>
            <div class="admin-grid">
                <div class="admin-list" style="grid-column: 1 / -1;">
                    <h4 style="color:#e67e22;">‚è≥ Pendentes</h4>
                    <div id="pendingMuralList"></div>
                    <h4 style="color:var(--success); margin-top:20px;">‚úÖ No Ar</h4>
                    <div id="muralList"></div>
                </div>
            </div>
        </section>

        <section style="margin-top: 3rem;">
            <h2>Gerar C√≥digo de Resgate</h2>
            <div style="background:white; padding:1.5rem; border-radius:12px; display:flex; gap:10px;">
                <select id="manualBadgeSelect" style="margin:0;"><option>Carregando...</option></select>
                <button onclick="generateCode()" class="secondary">Gerar C√≥digo</button>
            </div>
            <div id="generatedCodeDisplay" class="code-box"></div>
        </section>

    </div>

    <script>
        const SUPABASE_URL = 'https://rfgijfpokictktdrenbl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZ2lqZnBva2ljdGt0ZHJlbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTYyNjUsImV4cCI6MjA3ODQzMjI2NX0.xvQBUxEtH8pad25fac6lDU4WbD-fI3L6BcRO9bsO0GE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- AUTH ---
        checkAuth();
        async function checkAuth() { const {data:{session}} = await supabase.auth.getSession(); if(session){ document.getElementById('authScreen').style.display='none'; document.getElementById('adminLayout').style.display='block'; loadAllData(); } }
        document.getElementById('loginForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const {error} = await supabase.auth.signInWithPassword({email:document.getElementById('loginEmail').value, password:document.getElementById('loginPassword').value}); if(!error) location.reload(); else alert(error.message); });
        document.getElementById('logoutButton').addEventListener('click', async()=>{ await supabase.auth.signOut(); location.reload(); });

        async function loadAllData() {
            loadSectorsForBadges(); // Novo
            loadMuralData();
        }

        // --- NOVO: GERENCIADOR DE BADGES ---
        let sectorsData = [];

        async function loadSectorsForBadges() {
            const { data } = await supabase.from('aventuras').select('*').order('title');
            sectorsData = data || [];
            
            const badgeSel = document.getElementById('badgeSectorSelect');
            const codeSel = document.getElementById('manualBadgeSelect');
            
            badgeSel.innerHTML = '<option value="">-- Selecione o Setor --</option>';
            codeSel.innerHTML = '<option value="">-- Selecione --</option>';

            sectorsData.forEach(s => {
                const opt = `<option value="${s.id}">${s.title}</option>`;
                badgeSel.innerHTML += opt;
                codeSel.innerHTML += opt;
            });
        }

        window.checkExistingBadge = () => {
            const id = document.getElementById('badgeSectorSelect').value;
            const sector = sectorsData.find(s => s.id == id);
            const preview = document.getElementById('badgePreviewBox');
            const status = document.getElementById('badgeCurrentStatus');
            const nameInput = document.getElementById('badgeNameInput');

            if (sector) {
                nameInput.value = sector.title;
                if (sector.badge_url) {
                    preview.innerHTML = `<img src="${sector.badge_url}">`;
                    status.innerHTML = '<span style="color:green"><i class="fas fa-check"></i> Este setor j√° tem um badge oficial.</span>';
                } else {
                    // Se n√£o tiver badge oficial, mostra a capa como fallback ou vazio
                    preview.innerHTML = `<img src="${sector.image_url}" style="opacity:0.3; filter:grayscale(100%)">`;
                    status.innerHTML = '<span style="color:orange">Usando imagem de capa (Provis√≥rio). Suba um PNG!</span>';
                }
            } else {
                preview.innerHTML = '<span style="color:#ccc">...</span>';
                status.innerText = 'Selecione um setor.';
            }
        };

        window.uploadBadgeFile = async (input) => {
            const file = input.files[0];
            if (!file) return;
            
            const statusEl = document.getElementById('badgeImageStatus');
            statusEl.innerHTML = 'Enviando...';

            try {
                // Salva na pasta 'badges' para organizar
                const fileName = `badges/${Date.now()}_${file.name.replace(/\s/g, '_')}`;
                const { error } = await supabase.storage.from('imagens').upload(fileName, file); // Usando bucket imagens msm
                if (error) throw error;

                const { data } = supabase.storage.from('imagens').getPublicUrl(fileName);
                document.getElementById('badgeImageUrl').value = data.publicUrl;
                
                // Preview imediato
                document.getElementById('badgePreviewBox').innerHTML = `<img src="${data.publicUrl}">`;
                statusEl.innerHTML = '‚úÖ PNG Carregado!';
                statusEl.classList.add('success');

            } catch (e) {
                alert('Erro no upload: ' + e.message);
                statusEl.innerHTML = 'Erro';
            }
        };

        document.getElementById('badgeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('badgeSectorSelect').value;
            const url = document.getElementById('badgeImageUrl').value;
            const name = document.getElementById('badgeNameInput').value;

            if (!id || !url) return alert('Selecione o setor e fa√ßa o upload do PNG.');

            const { error } = await supabase.from('aventuras')
                .update({ badge_url: url, title: name }) // Atualiza URL do badge e Nome
                .eq('id', id);

            if (error) alert('Erro ao salvar: ' + error.message);
            else {
                alert('Badge Oficial atualizado com sucesso!');
                loadSectorsForBadges(); // Recarrega para atualizar dados locais
                // Reset visual simples
                document.getElementById('badgeImageStatus').className = 'status-indicator';
                document.getElementById('badgeImageStatus').innerHTML = 'Aguardando...';
            }
        });

        // --- MURAL ---
        async function loadMuralData() {
            const { data } = await supabase.from('mural').select('*').order('created_at', {ascending:false});
            const p = document.getElementById('pendingMuralList');
            const a = document.getElementById('muralList');
            p.innerHTML=''; a.innerHTML='';
            if(data) data.forEach(m => {
                const html = `<div class="item"><div class="item-info"><img src="${m.image_url}" onclick="window.open('${m.image_url}')"><div><strong>${m.author}</strong> - ${m.title}</div></div><div class="item-actions">${m.status==='pending' ? `<button class="success" onclick="updMural('${m.id}','approved')">‚úî</button><button class="danger" onclick="delMural('${m.id}')">‚úñ</button>` : `<button class="danger" onclick="delMural('${m.id}')">üóë</button>`}</div></div>`;
                if(m.status==='pending') p.innerHTML+=html; else a.innerHTML+=html;
            });
        }
        window.updMural = async(id,s)=>{ await supabase.from('mural').update({status:s}).eq('id',id); loadMuralData(); };
        window.delMural = async(id)=>{ if(confirm('Apagar?')) { await supabase.from('mural').delete().eq('id',id); loadMuralData(); } };

        // --- C√ìDIGOS ---
        window.generateCode = async () => {
            const id = document.getElementById('manualBadgeSelect').value;
            if(!id) return alert('Escolha a aventura');
            const code = `ARANHA-${Math.random().toString(36).substring(2,6).toUpperCase()}`;
            await supabase.from('redeem_codes').insert([{code, adventure_id:id}]);
            const display = document.getElementById('generatedCodeDisplay');
            display.style.display='block'; display.textContent=code;
        };

    </script>
</body>
</html>