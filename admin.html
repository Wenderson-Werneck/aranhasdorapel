<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Aranhas do Rapel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #E83D8A; --secondary: #0055A4; --light: #FDF2F8; --white: #ffffff; --dark: #1A202C; --danger: #e53e3e; --success: #27ae60; --radius: 12px; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); color: var(--dark); margin: 0; padding-bottom: 80px; }
        .container { width: 95%; max-width: 1200px; margin: 2rem auto; }
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 50px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        button.danger { background: var(--danger); }
        button.secondary { background: var(--secondary); }
        button.success { background: var(--success); }
        button.outline { background: transparent; border: 2px solid #ccc; color: #666; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0 16px 0; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        form { background: var(--white); padding: 2rem; border-radius: var(--radius); border-top: 4px solid var(--primary); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .upload-group { display: flex; gap: 10px; align-items: center; margin-bottom: 16px; margin-top: 5px; }
        .status-indicator { flex: 1; display: flex; align-items: center; gap: 10px; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; background: #f1f5f9; border: 1px dashed #cbd5e1; color: #64748b; transition: 0.3s; }
        .status-indicator.success { background: #dcfce7; border-color: var(--success); color: var(--success); font-weight: bold; }
        .file-label { background: var(--secondary); color: white; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-weight: bold; display: flex; align-items: center; gap: 8px; white-space: nowrap; transition: 0.3s; }
        input[type="file"] { display: none; }
        .admin-layout, .code-box { display: none; }
        .auth-screen { text-align: center; padding: 3rem; background: var(--white); max-width: 400px; margin: 5rem auto; border-top: 5px solid var(--primary); }
        .admin-header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 1rem 2rem; border-radius: var(--radius); margin-bottom: 2rem; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem; }
        .admin-list { background: white; padding: 1.5rem; border-radius: var(--radius); }
        .item { background: #fff; border-bottom: 1px solid #eee; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; }
        .item-info { display: flex; align-items: center; gap: 1rem; }
        .item-info img { width: 50px; height: 50px; object-fit: cover; border-radius: 8px; }
        .item-actions { display: flex; gap: 5px; }
        .item-actions button { padding: 6px 12px; font-size: 0.8rem; border-radius: 6px; }
        .code-box { background: #2d3748; color: #48bb78; font-family: monospace; font-size: 2rem; padding: 20px; border-radius: 10px; text-align: center; letter-spacing: 5px; font-weight: bold; margin-top: 20px; border: 2px dashed #48bb78; }
        @media (max-width: 768px) { .admin-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-screen">
        <h2>Admin Aranhas</h2>
        <form id="loginForm"><input type="email" id="loginEmail" placeholder="Email"><input type="password" id="loginPassword" placeholder="Senha"><button type="submit" style="width:100%">Entrar</button></form>
    </div>

    <div id="adminLayout" class="admin-layout container">
        <div class="admin-header"><h1>Painel de Controle</h1><button id="logoutButton" class="danger">Sair</button></div>
        
        <section style="margin-bottom:3rem; background:#e3f2fd; padding:2rem; border-radius:12px; border:2px dashed #90caf9;">
            <h2 style="margin:0 0 1rem 0; color:var(--secondary);">Gerar Código de Resgate</h2>
            <form id="codeGenForm" style="box-shadow:none; border:none; padding:0; background:transparent;">
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div style="flex:1;"><label>Escolher Aventura</label><select id="manualBadgeSelect" required style="margin-bottom:0;"></select></div>
                    <button type="submit" class="success" style="height:48px; margin-bottom:0;"><i class="fas fa-bolt"></i> Gerar</button>
                </div>
            </form>
            <div id="generatedCodeDisplay" class="code-box"></div>
        </section>

        <section><h2>Agenda</h2><div class="admin-grid">
            <form id="agendaForm">
                <h3 id="agendaFormTitle">Adicionar Evento</h3><input type="hidden" id="agendaId">
                <input type="text" id="agendaTitle" placeholder="Título" required>
                <div style="background:#f0f4f8; padding:10px; border-radius:8px; margin-bottom:10px;"><label style="margin:0">Vincular Aventura</label><select id="agendaAdventureId" style="margin:0"><option value="">-- Selecione --</option></select></div>
                <div style="display:grid; grid-template-columns:2fr 1fr; gap:10px;"><input type="text" id="agendaDate" placeholder="Data" required><input type="number" id="agendaPrice" placeholder="R$ 0.00" step="0.01" required></div>
                <label>Imagem</label><div class="upload-group"><input type="hidden" id="agendaImage" required><div id="agendaImageStatus" class="status-indicator"><i class="fas fa-image"></i> Aguardando...</div><label class="file-label">Upload <input type="file" onchange="uploadImage(this,'agendaImage')"></label></div>
                <div style="display:flex; gap:10px;"><button type="submit" style="flex:1">Salvar</button><button type="button" id="cancelEditAgenda" class="outline" style="display:none">Cancelar</button></div>
            </form>
            <div class="admin-list" id="agendaList"></div>
        </div></section>

        <hr style="margin:3rem 0; border:0; border-top:1px dashed #ccc;">

        <section><h2>Aventuras</h2><div class="admin-grid">
            <form id="adventureForm">
                <h3 id="adventureFormTitle">Nova Aventura</h3><input type="hidden" id="adventureId">
                <input type="text" id="adventureTitle" placeholder="Título" required><input type="text" id="adventureSubtitle" placeholder="Subtítulo" required>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><select id="adventureDifficulty"><option value="facil">Fácil</option><option value="medio">Médio</option><option value="dificil">Difícil</option></select><input type="text" id="adventureDuration" placeholder="Duração"></div>
                <textarea id="adventureDescription" rows="3" placeholder="Descrição" required></textarea>
                <label>Capa</label><div class="upload-group"><input type="hidden" id="adventureImage" required><div id="adventureImageStatus" class="status-indicator"><i class="fas fa-image"></i> Aguardando...</div><label class="file-label">Upload <input type="file" onchange="uploadImage(this,'adventureImage')"></label></div>
                <div style="display:flex; gap:10px;"><button type="submit" style="flex:1">Salvar</button><button type="button" id="cancelEditAdventure" class="outline" style="display:none">Cancelar</button></div>
            </form>
            <div class="admin-list" id="adventureList"></div>
        </div></section>

        <hr style="margin:3rem 0; border:0; border-top:1px dashed #ccc;">

        <section><h2>Gerenciar Mural</h2><div class="admin-grid">
            <form id="muralForm">
                <h3 id="muralFormTitle">Postar Manualmente</h3><input type="hidden" id="muralId">
                <input type="text" id="muralTitle" placeholder="Local" required><input type="text" id="muralAuthor" placeholder="Autor" required><textarea id="muralQuote" rows="3" placeholder="Depoimento" required></textarea>
                <label>Foto</label><div class="upload-group"><input type="hidden" id="muralImage" required><div id="muralImageStatus" class="status-indicator"><i class="fas fa-image"></i> Aguardando...</div><label class="file-label">Upload <input type="file" onchange="uploadImage(this,'muralImage')"></label></div>
                <div style="display:flex; gap:10px;"><button type="submit" style="flex:1">Salvar</button><button type="button" id="cancelEditMural" class="outline" style="display:none">Cancelar</button></div>
            </form>
            <div class="admin-list">
                <h4 style="color:var(--danger); border-bottom:2px solid #eee; padding-bottom:10px;">Pendentes de Aprovação</h4>
                <div id="pendingMuralList"></div>
                <h4 style="color:var(--success); margin-top:20px; border-bottom:2px solid #eee; padding-bottom:10px;">No Ar</h4>
                <div id="muralList"></div>
            </div>
        </div></section>
    </div>

    <script>
        const SUPABASE_URL = 'https://rfgijfpokictktdrenbl.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZ2lqZnBva2ljdGt0ZHJlbmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4NTYyNjUsImV4cCI6MjA3ODQzMjI2NX0.xvQBUxEtH8pad25fac6lDU4WbD-fI3L6BcRO9bsO0GE';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Upload Helper
        window.uploadImage = async (input, id) => {
            const file = input.files[0]; if(!file) return;
            const status = document.getElementById(id+'Status');
            status.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...'; status.className='status-indicator';
            try {
                const fileName = `admin/${Date.now()}_${file.name.replace(/\s/g,'_')}`;
                const { error } = await supabase.storage.from('imagens').upload(fileName, file); if(error) throw error;
                const { data } = supabase.storage.from('imagens').getPublicUrl(fileName);
                document.getElementById(id).value = data.publicUrl;
                status.innerHTML = '<i class="fas fa-check"></i> Pronto!'; status.classList.add('success');
            } catch(e) { alert(e.message); status.innerHTML='Erro'; }
        };
        function setGreen(id){ const s=document.getElementById(id+'Status'); s.innerHTML='<i class="fas fa-check"></i> Salva'; s.classList.add('success'); }
        function resetGreen(id){ const s=document.getElementById(id+'Status'); s.innerHTML='<i class="fas fa-image"></i> Aguardando...'; s.classList.remove('success'); }

        // Data & Lists
        const agendaList=document.getElementById('agendaList'), adventureList=document.getElementById('adventureList'), muralList=document.getElementById('muralList'), pendingList=document.getElementById('pendingMuralList');
        const badgeSelect=document.getElementById('manualBadgeSelect'), agendaAdvSelect=document.getElementById('agendaAdventureId');

        checkAuth();
        async function checkAuth() { const {data:{session}} = await supabase.auth.getSession(); if(session){ document.getElementById('authScreen').style.display='none'; document.getElementById('adminLayout').style.display='block'; loadData(); } }
        document.getElementById('loginForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const {error} = await supabase.auth.signInWithPassword({email:document.getElementById('loginEmail').value, password:document.getElementById('loginPassword').value}); if(!error) location.reload(); else alert(error.message); });
        document.getElementById('logoutButton').addEventListener('click', async()=>{ await supabase.auth.signOut(); location.reload(); });

        async function loadData() {
            const {data:advs} = await supabase.from('aventuras').select('*').order('title');
            if(advs) {
                badgeSelect.innerHTML='<option value="">-- Selecione --</option>'; agendaAdvSelect.innerHTML='<option value="">-- Selecione --</option>';
                advs.forEach(a=>{ const o=`<option value="${a.id}">${a.title}</option>`; badgeSelect.innerHTML+=o; agendaAdvSelect.innerHTML+=o; });
                adventureList.innerHTML=''; advs.forEach(i=>adventureList.appendChild(createItem(i, 'aventuras')));
            }
            loadAgenda(); loadMural(); loadPendingMural();
        }

        function createItem(i, type) {
            const el=document.createElement('div'); el.className='item'; el.dataset.id=i.id;
            let info = type==='agenda' ? `<strong>${i.title}</strong><br>${i.date_text}` : (type==='aventuras' ? `<strong>${i.title}</strong><br>${i.subtitle}` : `<strong>${i.title}</strong><br>${i.author}`);
            el.innerHTML=`<div class="item-info"><img src="${i.image_url}"><div>${info}</div></div><div class="item-actions"><button class="secondary" onclick="edit('${type}','${i.id}')"><i class="fas fa-edit"></i></button><button class="danger" onclick="del('${type}','${i.id}')"><i class="fas fa-trash"></i></button></div>`;
            return el;
        }

        async function loadAgenda() { const {data} = await supabase.from('agenda').select('*').order('display_order'); agendaList.innerHTML=''; data?.forEach(i=>agendaList.appendChild(createItem(i,'agenda'))); new Sortable(agendaList,{animation:150, onEnd:async()=>{ const u=[]; agendaList.querySelectorAll('.item').forEach((e,x)=>u.push(supabase.from('agenda').update({display_order:x}).eq('id',e.dataset.id))); await Promise.all(u); }}); }
        
        async function loadMural() { const {data} = await supabase.from('mural').select('*').eq('status','approved').order('created_at',{ascending:false}); muralList.innerHTML=''; data?.forEach(i=>muralList.appendChild(createItem(i,'mural'))); }
        
        async function loadPendingMural() {
            const {data} = await supabase.from('mural').select('*').eq('status','pending');
            pendingList.innerHTML = '';
            if(!data || !data.length) pendingList.innerHTML = '<p style="color:#aaa;font-size:0.8rem">Nada pendente.</p>';
            else data.forEach(i => {
                pendingList.innerHTML += `<div class="item" style="background:#fff3cd"><div class="item-info"><img src="${i.image_url}"><div><strong>${i.author}</strong><br>${i.title}</div></div><div class="item-actions"><button class="success" onclick="approve('${i.id}')"><i class="fas fa-check"></i></button><button class="danger" onclick="del('mural','${i.id}')"><i class="fas fa-times"></i></button></div></div>`;
            });
        }

        // Actions
        window.del = async(t,id) => { if(confirm('Apagar?')) { await supabase.from(t).delete().eq('id',id); loadData(); } };
        window.approve = async(id) => { if(confirm('Aprovar?')) { await supabase.from('mural').update({status:'approved'}).eq('id',id); loadMural(); loadPendingMural(); } };
        window.edit = async(t,id) => {
            const {data} = await supabase.from(t).select('*').eq('id',id).single();
            if(t==='agenda') { document.getElementById('agendaId').value=data.id; document.getElementById('agendaTitle').value=data.title; document.getElementById('agendaDate').value=data.date_text; document.getElementById('agendaPrice').value=data.price; document.getElementById('agendaImage').value=data.image_url; setGreen('agendaImage'); document.getElementById('agendaAdventureId').value=data.adventure_id||""; document.getElementById('cancelEditAgenda').style.display='block'; }
            if(t==='aventuras') { document.getElementById('adventureId').value=data.id; document.getElementById('adventureTitle').value=data.title; document.getElementById('adventureSubtitle').value=data.subtitle; document.getElementById('adventureDuration').value=data.duration; document.getElementById('adventureDescription').value=data.description; document.getElementById('adventureImage').value=data.image_url; setGreen('adventureImage'); document.getElementById('adventureDifficulty').value=data.difficulty; document.getElementById('cancelEditAdventure').style.display='block'; }
            if(t==='mural') { document.getElementById('muralId').value=data.id; document.getElementById('muralTitle').value=data.title; document.getElementById('muralAuthor').value=data.author; document.getElementById('muralQuote').value=data.quote; document.getElementById('muralImage').value=data.image_url; setGreen('muralImage'); document.getElementById('cancelEditMural').style.display='block'; }
        };

        // Code Gen
        document.getElementById('codeGenForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const adv=badgeSelect.value; if(!adv)return alert('Selecione!'); const code=`ARANHA-${Math.random().toString(36).substring(2,6).toUpperCase()}`; const {error}=await supabase.from('redeem_codes').insert([{code, adventure_id:adv}]); if(error)alert(error.message); else { document.getElementById('generatedCodeDisplay').style.display='block'; document.getElementById('generatedCodeDisplay').innerHTML=code; } });

        // Submit Forms
        const handleSub = async(e,t,idField,fields) => { e.preventDefault(); const id=document.getElementById(idField).value; const d={}; fields.forEach(f=>d[f]=document.getElementById(t+f.charAt(0).toUpperCase()+f.slice(1)).value); if(t==='agenda') d.adventure_id=document.getElementById('agendaAdventureId').value||null; if(id) await supabase.from(t).update(d).eq('id',id); else { if(t==='mural') d.status='approved'; await supabase.from(t).insert([d]); } reset(t); loadData(); };
        
        document.getElementById('agendaForm').addEventListener('submit', (e)=>handleSub(e,'agenda','agendaId',['title','date','price','image']));
        document.getElementById('adventureForm').addEventListener('submit', (e)=>handleSub(e,'aventuras','adventureId',['title','subtitle','difficulty','duration','description','image'])); // Note: fields must match form IDs somewhat, tweaked in handleSub logic? No, let's fix handleSub or standardise IDs. 
        // Simplification for reliability:
        document.getElementById('muralForm').addEventListener('submit', async(e)=>{ e.preventDefault(); const id=document.getElementById('muralId').value; const d={title:document.getElementById('muralTitle').value, author:document.getElementById('muralAuthor').value, quote:document.getElementById('muralQuote').value, image_url:document.getElementById('muralImage').value, status:'approved'}; if(id) await supabase.from('mural').update(d).eq('id',id); else await supabase.from('mural').insert([d]); reset('mural'); loadMural(); });

        function reset(t){ document.getElementById(t+'Form').reset(); document.getElementById(t+'Id').value=''; resetGreen(t+'Image'); document.getElementById('cancelEdit'+t.charAt(0).toUpperCase()+t.slice(1)).style.display='none'; }
        document.getElementById('cancelEditAgenda').onclick=()=>reset('agenda'); document.getElementById('cancelEditAdventure').onclick=()=>reset('adventure'); document.getElementById('cancelEditMural').onclick=()=>reset('mural');
    </script>
</body>
</html>